---
- name: Install PostgreSQL
  pacman:
    name: postgresql
    state: present
  tags:
    - postgresql

# needed by ansible to create databases
- name: Install psycopg2
  pacman:
    name: python2-psycopg2
    state: present
  tags:
    - postgresql

- name: Initialize database cluster
  command:
    initdb --locale en_US.UTF-8 -E UTF8 -D /var/lib/postgres/data
    creates=/var/lib/postgres/data/postgresql.conf
  become: yes
  become_user: postgres
  tags:
    - postgresql

- name: Disable synchronous commits
  lineinfile:
    dest: /var/lib/postgres/data/postgresql.conf
    regexp: ^synchronous_commit
    state: present
    line: "synchronous_commit = off"
  notify:
    - restart postgresql
  tags:
    - postgresql

- name: Prevent disk writes when idle
  lineinfile:
    dest: /var/lib/postgres/data/postgresql.conf
    regexp: ^stats_temp_directory
    state: present
    line: "stats_temp_directory = '/run/postgresql'"
  notify:
    - restart postgresql
  tags:
    - postgresql

- name: Enable and start PostgreSQL
  service:
    name: postgresql.service
    enabled: yes
    state: started
  tags:
    - postgresql

- name: Create the PostgreSQL user
  postgresql_user:
    name: "{{ ansible_user }}"
    role_attr_flags: CREATEDB,SUPERUSER
  tags:
    - postgresql

- name: Create a default Database for user
  postgresql_db:
    name: "{{ ansible_user }}"
    login_user: "{{ ansible_user }}"
    owner: "{{ ansible_user }}"
    state: present
  tags:
    - postgresql
