# {{ ansible_managed }}

server {
  listen 443 ssl http2;
  listen [::]:443 ssl http2;
  server_name git.jlrickert.me;

  ssl_certificate /etc/letsencrypt/live/git.jlrickert.me/fullchain.pem; # managed by Certbot
  ssl_certificate_key /etc/letsencrypt/live/git.jlrickert.me/privkey.pem; # managed by Certbot

  access_log /var/log/nginx/git.jlrickert.me/access.log;
  error_log /var/log/nginx/git.jlrickert.me/error.log;

  auth_basic            "Restricted";
  auth_basic_user_file  /etc/nginx/htpasswd;

  # root /usr/share/gitweb;
  root /srv/git;
  index index.html;

  # # static repo files for cloning over https
  # location ~ ^.*\.git/objects/([0-9a-f]+/[0-9a-f]+|pack/pack-[0-9a-f]+.(pack|idx))$ {
  #   root /srv/git;
  # }

  location / {
    # Set chunks to unlimited, as the body's can be huge
		client_max_body_size			0;

		include       fastcgi.conf;
		fastcgi_pass	unix:/var/run/fcgiwrap.sock;
		fastcgi_param	SCRIPT_FILENAME /usr/lib/git-core/git-http-backend;
		fastcgi_param	GIT_HTTP_EXPORT_ALL	"";
		fastcgi_param	GIT_PROJECT_ROOT /srv/git;
		fastcgi_param	PATH_INFO $1;

		# Forward REMOTE_USER as we want to know when we are authenticated
		fastcgi_param	REMOTE_USER		$remote_user;
	}

  # location / {
  #   include fastcgi_params;
  #   gzip off;
  #   fastcgi_param   SCRIPT_FILENAME  /usr/share/gitweb/gitweb.cgi;
	# 	fastcgi_param	  GIT_HTTP_EXPORT_ALL	"";
  #   fastcgi_param   GITWEB_CONFIG  /etc/gitweb.conf;
  #   fastcgi_pass    unix:/var/run/fcgiwrap.sock;
  # }

  error_page 404 /404.html;

  include conf.d/letsencrypt.conf;
}
